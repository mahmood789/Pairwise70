<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAFI Calculator - Complete Edition with GRADE Integration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #06b6d4;
            --accent-light: #22d3ee;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --danger: #ef4444;
            --danger-light: #f87171;
            --info: #3b82f6;
            --bg-dark: #0f172a;
            --bg-medium: #1e293b;
            --bg-light: #334155;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(148, 163, 184, 0.1);
            --border-light: rgba(148, 163, 184, 0.2);
            --robust: #10b981;
            --low: #22d3ee;
            --moderate: #f59e0b;
            --high: #ef4444;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px var(--primary-glow);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 50%, var(--bg-dark) 100%);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        .container { max-width: 1500px; margin: 0 auto; padding: 30px; }

        header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(6, 182, 212, 0.15) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            color: white;
            padding: 50px 40px;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(99, 102, 241, 0.1), transparent 30%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 12px;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #c7d2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            letter-spacing: -0.02em;
        }

        header p {
            opacity: 0.8;
            font-size: 1.15rem;
            font-weight: 400;
            position: relative;
            color: var(--text-secondary);
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-subtle);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--border-light);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 700;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            border-radius: 2px;
        }

        .card h3 {
            color: var(--text-primary);
            margin: 24px 0 16px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 28px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            font-size: 15px;
            background: var(--bg-glass);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow), var(--shadow-sm);
            background: rgba(99, 102, 241, 0.05);
        }

        textarea {
            min-height: 140px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: var(--bg-medium);
            border-color: var(--primary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn-group { display: flex; gap: 14px; flex-wrap: wrap; margin-top: 24px; }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 16px 18px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 100%);
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        td {
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-glass);
        }

        tr:hover td {
            background: rgba(99, 102, 241, 0.05);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--bg-glass) 0%, rgba(99, 102, 241, 0.05) 100%);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .stat-box .value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-box .label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mafi-score {
            font-size: 5rem;
            font-weight: 900;
            text-align: center;
            padding: 40px;
            border-radius: 24px;
            margin: 28px 0;
            position: relative;
            overflow: hidden;
            letter-spacing: -0.02em;
        }

        .mafi-score::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .mafi-robust {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.15) 100%);
            color: var(--success-light);
            border: 2px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.2);
        }

        .mafi-low {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(34, 211, 238, 0.15) 100%);
            color: var(--accent-light);
            border: 2px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 60px rgba(6, 182, 212, 0.2);
        }

        .mafi-moderate {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(251, 191, 36, 0.15) 100%);
            color: var(--warning-light);
            border: 2px solid rgba(245, 158, 11, 0.3);
            box-shadow: 0 0 60px rgba(245, 158, 11, 0.2);
        }

        .mafi-high {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.15) 100%);
            color: var(--danger-light);
            border: 2px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 60px rgba(239, 68, 68, 0.2);
        }

        .classification-label {
            font-size: 1.6rem;
            font-weight: 700;
            display: block;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-robust { background: rgba(16, 185, 129, 0.2); color: var(--success-light); border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-low { background: rgba(6, 182, 212, 0.2); color: var(--accent-light); border: 1px solid rgba(6, 182, 212, 0.3); }
        .badge-moderate { background: rgba(245, 158, 11, 0.2); color: var(--warning-light); border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-high { background: rgba(239, 68, 68, 0.2); color: var(--danger-light); border: 1px solid rgba(239, 68, 68, 0.3); }

        .progress-bar {
            height: 28px;
            background: var(--bg-light);
            border-radius: 14px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .forest-plot {
            padding: 24px;
            background: var(--bg-glass);
            border-radius: 16px;
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
        }

        .forest-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.2s ease;
        }

        .forest-row:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .forest-label {
            width: 160px;
            font-weight: 500;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .forest-plot-area {
            flex: 1;
            position: relative;
            height: 36px;
            margin: 0 24px;
        }

        .forest-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-light);
        }

        .forest-null {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--text-muted);
            left: 50%;
            transform: translateX(-50%);
        }

        .forest-point {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
        }

        .forest-ci {
            position: absolute;
            top: 50%;
            height: 4px;
            background: var(--primary);
            transform: translateY(-50%);
            border-radius: 2px;
        }

        .forest-effect {
            width: 110px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .fragility-indicator {
            width: 90px;
            text-align: center;
            flex-shrink: 0;
        }

        .tabs {
            display: flex;
            background: var(--bg-glass);
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 4px;
            border: 1px solid var(--border-subtle);
        }

        .tab {
            padding: 14px 28px;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #93c5fd;
            backdrop-filter: blur(10px);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #fcd34d;
            backdrop-filter: blur(10px);
        }

        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #6ee7b7;
            backdrop-filter: blur(10px);
        }

        .danger-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #fca5a5;
            backdrop-filter: blur(10px);
        }

        .component-bar {
            display: flex;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .component-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            transition: all 0.3s ease;
        }

        .component-segment:hover {
            filter: brightness(1.1);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
        }

        .hidden { display: none !important; }

        .variant-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .variant-card {
            background: linear-gradient(135deg, var(--bg-glass) 0%, rgba(99, 102, 241, 0.05) 100%);
            padding: 28px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .variant-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .variant-card h4 {
            margin-bottom: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }

        .variant-card .score {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* GRADE Specific Styles */
        .grade-table { margin: 24px 0; }

        .grade-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .grade-high { background: rgba(16, 185, 129, 0.15); }
        .grade-moderate { background: rgba(6, 182, 212, 0.15); }
        .grade-low { background: rgba(245, 158, 11, 0.15); }
        .grade-very-low { background: rgba(239, 68, 68, 0.15); }

        .grade-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin: 0 3px;
            transition: all 0.3s ease;
        }

        .grade-filled {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: 0 2px 10px var(--primary-glow);
        }

        .grade-empty {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
        }

        .case-study {
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
        }

        .case-study:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md), 0 0 30px var(--primary-glow);
            transform: translateY(-4px);
        }

        .case-study h4 {
            color: var(--primary-light);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .case-study-meta {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .downgrade-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: 12px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .downgrade-item.active {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .downgrade-item.inactive {
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
        }

        .downgrade-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            accent-color: var(--primary);
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            header h1 { font-size: 2rem; }
            .mafi-score { font-size: 3.5rem; padding: 30px; }
            .container { padding: 16px; }
            .tabs { flex-direction: column; }
            .tab { width: 100%; text-align: center; }
        }

        .export-section {
            background: var(--bg-glass);
            padding: 24px;
            border-radius: 16px;
            margin-top: 24px;
            border: 1px solid var(--border-subtle);
        }

        #exportText {
            width: 100%;
            height: 220px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 12px;
            background: var(--bg-dark);
            color: var(--accent-light);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
        }

        .remove-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-light);
            border-radius: 5px;
            border: 2px solid var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Selection Styling */
        ::selection {
            background: var(--primary);
            color: white;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .clinical-input {
            background: #fef3c7;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MAFI Calculator - Complete Edition</h1>
            <p>Meta-Analysis Fragility Index with GRADE Integration & Case Studies</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="card">
            <nav class="tabs" role="tablist" aria-label="Main navigation">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="calculatorTab" onclick="switchMainTab('calculator')">Calculator</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="casestudiesTab" onclick="switchMainTab('casestudies')">Worked Case Studies</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="gradeTab" onclick="switchMainTab('grade')">GRADE Integration</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="documentationTab" onclick="switchMainTab('documentation')">Documentation</button>
            </nav>

            <!-- Calculator Tab -->
            <div id="calculatorTab" class="tab-content active">
                <h2>Study Data Input</h2>

                <div class="grid-2">
                    <div>
                        <div class="form-group">
                            <label>Effect Measure</label>
                            <select id="effectMeasure">
                                <option value="SMD">Standardized Mean Difference (SMD)</option>
                                <option value="MD">Mean Difference (MD)</option>
                                <option value="OR">Odds Ratio (OR)</option>
                                <option value="RR">Risk Ratio (RR)</option>
                                <option value="HR">Hazard Ratio (HR)</option>
                            </select>
                        </div>
                    </div>
                    <div class="clinical-input">
                        <div class="form-group">
                            <label>Clinical Threshold (MCID)</label>
                            <input type="number" id="clinicalThreshold" step="0.01" placeholder="e.g., 0.5 for SMD, 1.25 for OR">
                            <small style="color: var(--text-muted);">Minimum clinically important difference</small>
                        </div>
                    </div>
                </div>

                <h3>Study Data</h3>
                <div style="overflow-x: auto;">
                    <table id="studyTable">
                        <thead>
                            <tr>
                                <th style="width: 180px;">Study Name</th>
                                <th style="width: 120px;">Effect Size</th>
                                <th style="width: 120px;">Standard Error</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="studyTableBody"></tbody>
                    </table>
                </div>

                <div class="btn-group">
                    <button class="btn-secondary" onclick="addStudyRow()" aria-label="Add one study row">+ Add Study</button>
                    <button class="btn-secondary" onclick="addMultipleRows()" aria-label="Add five study rows">+ Add 5 Studies</button>
                    <button class="btn-danger" onclick="clearAllStudies()" aria-label="Clear all studies">Clear All</button>
                    <button class="btn-secondary" onclick="loadExampleData('depression')" aria-label="Load example depression data">Load Example</button>
                </div>

                <!-- Import/Export Session -->
                <div class="btn-group" style="margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border-subtle);">
                    <input type="file" id="csvFileInput" accept=".csv,.txt" style="display: none;" onchange="importCSV(event)" aria-label="Import CSV file">
                    <button class="btn-secondary" onclick="document.getElementById('csvFileInput').click()" aria-label="Import data from CSV file">Import CSV</button>
                    <button class="btn-secondary" onclick="saveSession()" aria-label="Save current session">Save Session</button>
                    <button class="btn-secondary" onclick="loadSession()" aria-label="Load saved session">Load Session</button>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn-primary" style="font-size: 1.2rem; padding: 16px 48px;" onclick="runAnalysis()">
                        Run MAFI Analysis
                    </button>
                </div>
            </div>

            <!-- Case Studies Tab -->
            <div id="casestudiesTab" class="tab-content">
                <h2>Worked Case Studies</h2>
                <p style="margin-bottom: 20px;">Click on any case study to load the data and see the MAFI analysis.</p>

                <div class="case-study" onclick="loadCaseStudy('antidepressants')">
                    <h4>Case Study 1: Antidepressants for Major Depression</h4>
                    <p>A meta-analysis of 8 RCTs examining the efficacy of SSRIs vs placebo for major depressive disorder, using the Hamilton Depression Rating Scale (HDRS).</p>
                    <div class="case-study-meta">
                        <span class="badge badge-low">k = 8 studies</span>
                        <span class="badge" style="background: var(--info); color: white;">SMD outcome</span>
                        <span class="badge badge-moderate">Expected: Low-Moderate Fragility</span>
                    </div>
                </div>

                <div class="case-study" onclick="loadCaseStudy('mortality')">
                    <h4>Case Study 2: Statin Therapy and All-Cause Mortality</h4>
                    <p>A meta-analysis of 12 RCTs examining statin therapy vs control for prevention of all-cause mortality in patients with cardiovascular disease.</p>
                    <div class="case-study-meta">
                        <span class="badge badge-robust">k = 12 studies</span>
                        <span class="badge" style="background: var(--info); color: white;">OR outcome</span>
                        <span class="badge badge-robust">Expected: Robust</span>
                    </div>
                </div>

                <div class="case-study" onclick="loadCaseStudy('pain')">
                    <h4>Case Study 3: Acupuncture for Chronic Low Back Pain</h4>
                    <p>A meta-analysis of 6 RCTs examining acupuncture vs sham acupuncture for chronic low back pain, measured on a 100-point VAS scale.</p>
                    <div class="case-study-meta">
                        <span class="badge badge-moderate">k = 6 studies</span>
                        <span class="badge" style="background: var(--info); color: white;">MD outcome</span>
                        <span class="badge badge-high">Expected: High Fragility</span>
                    </div>
                </div>

                <div class="case-study" onclick="loadCaseStudy('vaccine')">
                    <h4>Case Study 4: COVID-19 Vaccine Efficacy</h4>
                    <p>A meta-analysis of 5 phase 3 trials examining mRNA vaccine efficacy against symptomatic COVID-19 infection.</p>
                    <div class="case-study-meta">
                        <span class="badge badge-low">k = 5 studies</span>
                        <span class="badge" style="background: var(--info); color: white;">RR outcome</span>
                        <span class="badge badge-robust">Expected: Robust (large effects)</span>
                    </div>
                </div>

                <div class="case-study" onclick="loadCaseStudy('fragile')">
                    <h4>Case Study 5: Exercise for Fibromyalgia (High Fragility Example)</h4>
                    <p>A meta-analysis of 4 small RCTs examining exercise therapy for fibromyalgia symptom relief. Demonstrates a highly fragile conclusion.</p>
                    <div class="case-study-meta">
                        <span class="badge badge-high">k = 4 studies</span>
                        <span class="badge" style="background: var(--info); color: white;">SMD outcome</span>
                        <span class="badge badge-high">Expected: High Fragility</span>
                    </div>
                </div>
            </div>

            <!-- GRADE Tab -->
            <div id="gradeTab" class="tab-content">
                <h2>GRADE Integration Pilot</h2>

                <div class="info-box">
                    <strong>About GRADE Integration:</strong> The Grading of Recommendations Assessment, Development and Evaluation (GRADE) approach is used to rate the certainty of evidence. This tool provides suggestions for how MAFI results might inform GRADE assessments, particularly for the "Imprecision" domain.
                </div>

                <h3>GRADE Certainty Framework</h3>
                <table class="grade-table">
                    <thead>
                        <tr>
                            <th>Certainty Level</th>
                            <th>Symbol</th>
                            <th>Definition</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="grade-high">
                            <td><strong>High</strong></td>
                            <td>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                            </td>
                            <td>Very confident the true effect lies close to the estimate</td>
                        </tr>
                        <tr class="grade-moderate">
                            <td><strong>Moderate</strong></td>
                            <td>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-empty">O</span>
                            </td>
                            <td>Moderately confident; true effect likely close to estimate</td>
                        </tr>
                        <tr class="grade-low">
                            <td><strong>Low</strong></td>
                            <td>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-empty">O</span>
                                <span class="grade-circle grade-empty">O</span>
                            </td>
                            <td>Limited confidence; true effect may be substantially different</td>
                        </tr>
                        <tr class="grade-very-low">
                            <td><strong>Very Low</strong></td>
                            <td>
                                <span class="grade-circle grade-filled">+</span>
                                <span class="grade-circle grade-empty">O</span>
                                <span class="grade-circle grade-empty">O</span>
                                <span class="grade-circle grade-empty">O</span>
                            </td>
                            <td>Very little confidence; true effect likely substantially different</td>
                        </tr>
                    </tbody>
                </table>

                <h3>MAFI-Informed Downgrade Suggestions</h3>
                <div class="warning-box">
                    <strong>Important:</strong> These are SUGGESTIONS only. Final GRADE assessments should be made by the review team considering all domains. MAFI provides additional information but does not replace expert judgment.
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>MAFI Classification</th>
                            <th>Suggested Action</th>
                            <th>Rationale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-robust">Robust (0-0.15)</span></td>
                            <td>No downgrade for fragility</td>
                            <td>Conclusions stable to study exclusion; supports precision</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-low">Low (0.15-0.30)</span></td>
                            <td>Consider if borderline significance</td>
                            <td>Minor sensitivity; may inform imprecision judgment</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-moderate">Moderate (0.30-0.50)</span></td>
                            <td>Consider downgrade by 1 level</td>
                            <td>Conclusions may change with study exclusion</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-high">High (0.50+)</span></td>
                            <td>Consider downgrade by 1-2 levels</td>
                            <td>Conclusions highly unstable; serious imprecision concerns</td>
                        </tr>
                    </tbody>
                </table>

                <h3>GRADE Downgrade Calculator</h3>
                <div id="gradeCalculator">
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Run a MAFI analysis first to see personalized GRADE recommendations.</p>

                    <div id="gradeResults" class="hidden">
                        <!-- Filled dynamically -->
                    </div>
                </div>

                <h3>Integration with Other GRADE Domains</h3>
                <div class="grid-2">
                    <div class="info-box">
                        <h4>Risk of Bias</h4>
                        <p>MAFI is independent of risk of bias assessment. High-quality studies can still produce fragile meta-analyses if effect sizes are small or studies are few.</p>
                    </div>
                    <div class="info-box">
                        <h4>Inconsistency</h4>
                        <p>MAFI incorporates I² as a penalty term. High heterogeneity increases MAFI scores, partially overlapping with inconsistency assessment.</p>
                    </div>
                    <div class="info-box">
                        <h4>Indirectness</h4>
                        <p>MAFI does not assess indirectness. Population, intervention, comparator, and outcome relevance must be evaluated separately.</p>
                    </div>
                    <div class="info-box">
                        <h4>Publication Bias</h4>
                        <p>MAFI may be affected by publication bias. If positive studies are over-represented, excluding them may reverse conclusions (high fragility).</p>
                    </div>
                </div>
            </div>

            <!-- Documentation Tab -->
            <div id="documentationTab" class="tab-content">
                <h2>MAFI Documentation</h2>

                <h3>What is MAFI?</h3>
                <p>The Meta-Analysis Fragility Index (MAFI) is a composite measure that assesses how robust a meta-analysis conclusion is to the exclusion of individual studies. It was developed and validated using 4,424 Cochrane meta-analyses.</p>

                <h3>MAFI Formula</h3>
                <div class="info-box" style="font-family: monospace;">
                    <strong>MAFI = Core Score + Heterogeneity Penalty + Sample Size Penalty</strong><br><br>
                    Core Score = Σ(weight_i × component_i) where:<br>
                    &nbsp;&nbsp;• Direction Fragility (DFI): 30%<br>
                    &nbsp;&nbsp;• Significance Fragility (SFI): 25%<br>
                    &nbsp;&nbsp;• Clinical Fragility (CFI): 20%<br>
                    &nbsp;&nbsp;• Effect Stability: 15%<br>
                    &nbsp;&nbsp;• CI Stability: 10%<br><br>
                    Heterogeneity Penalty = (I²/100) × 0.20<br>
                    Sample Size Penalty = max(0, (1 - k/20) × 0.30)
                </div>

                <h3>Component Definitions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Definition</th>
                            <th>Calculation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Direction Fragility Index (DFI)</strong></td>
                            <td>Number of studies whose removal changes the direction of the pooled effect</td>
                            <td>DFI / k</td>
                        </tr>
                        <tr>
                            <td><strong>Significance Fragility Index (SFI)</strong></td>
                            <td>Number of studies whose removal changes statistical significance (p < 0.05)</td>
                            <td>SFI / k</td>
                        </tr>
                        <tr>
                            <td><strong>Clinical Fragility Index (CFI)</strong></td>
                            <td>Number of studies whose removal crosses the clinical threshold (MCID)</td>
                            <td>CFI / k</td>
                        </tr>
                        <tr>
                            <td><strong>Effect Stability</strong></td>
                            <td>Maximum change in effect size when any study is removed</td>
                            <td>max(|Δeffect|)</td>
                        </tr>
                        <tr>
                            <td><strong>CI Stability (Fragility Quotient)</strong></td>
                            <td>Maximum proportional change in confidence interval width</td>
                            <td>max(|ΔCI_width| / CI_width)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>MAFI Classification</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Score Range</th>
                            <th>Classification</th>
                            <th>Interpretation</th>
                            <th>Expected Frequency</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="grade-high">
                            <td>0.00 - 0.15</td>
                            <td><span class="badge badge-robust">Robust</span></td>
                            <td>Highly stable conclusions</td>
                            <td>~27% of Cochrane MAs</td>
                        </tr>
                        <tr class="grade-moderate">
                            <td>0.15 - 0.30</td>
                            <td><span class="badge badge-low">Low Fragility</span></td>
                            <td>Minor sensitivity to study exclusion</td>
                            <td>~36% of Cochrane MAs</td>
                        </tr>
                        <tr class="grade-low">
                            <td>0.30 - 0.50</td>
                            <td><span class="badge badge-moderate">Moderate Fragility</span></td>
                            <td>Results may change with updated evidence</td>
                            <td>~25% of Cochrane MAs</td>
                        </tr>
                        <tr class="grade-very-low">
                            <td>0.50 - 1.00</td>
                            <td><span class="badge badge-high">High Fragility</span></td>
                            <td>Conclusions are unstable</td>
                            <td>~10% of Cochrane MAs</td>
                        </tr>
                    </tbody>
                </table>

                <h3>MAFI Variants</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Variant</th>
                            <th>Components</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>MAFI-5comp (Primary)</strong></td>
                            <td>All 5 components (30/25/20/15/10)</td>
                            <td>Comprehensive assessment; publication</td>
                        </tr>
                        <tr>
                            <td><strong>MAFI-3comp</strong></td>
                            <td>DFI + SFI + CI (35/35/30)</td>
                            <td>When clinical threshold unavailable</td>
                        </tr>
                        <tr>
                            <td><strong>MAFI-Simple</strong></td>
                            <td>DFI + SFI only (50/50)</td>
                            <td>Quick screening; teaching</td>
                        </tr>
                        <tr>
                            <td><strong>MAFI-Empirical</strong></td>
                            <td>Data-driven weights (17/30/0/0/52)</td>
                            <td>Predictive accuracy focus</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Validation Summary</h3>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li><strong>Sample:</strong> 4,424 meta-analyses from 473 Cochrane systematic reviews</li>
                    <li><strong>Review-Level CV AUC:</strong> 0.687 (SD 0.034)</li>
                    <li><strong>Weight Sensitivity:</strong> Robust to ±10% perturbations (max 4.8% class change)</li>
                    <li><strong>ICC:</strong> 16.1% variance between reviews</li>
                    <li><strong>Missing Data:</strong> 2.4% (appears random)</li>
                </ul>

                <h3>References</h3>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li>Atal I, et al. (2019). The statistical significance of meta-analyses is frequently fragile. J Clin Epidemiol.</li>
                    <li>Walsh M, et al. (2014). The statistical significance of randomized controlled trial results is frequently fragile. J Clin Epidemiol.</li>
                    <li>Guyatt GH, et al. (2011). GRADE guidelines. J Clin Epidemiol.</li>
                </ul>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Meta-Analysis Results -->
            <div class="card">
                <h2>Meta-Analysis Results</h2>
                <div class="grid-4">
                    <div class="stat-box">
                        <div class="value" id="pooledEffect">--</div>
                        <div class="label">Pooled Effect</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="pooledCI">--</div>
                        <div class="label">95% CI</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="pValue">--</div>
                        <div class="label">P-value</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="numStudies">--</div>
                        <div class="label">Studies (k)</div>
                    </div>
                </div>
                <div class="grid-3" style="margin-top: 20px;">
                    <div class="stat-box">
                        <div class="value" id="i2Value">--</div>
                        <div class="label">I² Heterogeneity</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="tau2Value">--</div>
                        <div class="label">τ² (Between-study variance)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="qValue">--</div>
                        <div class="label">Q statistic (p-value)</div>
                    </div>
                </div>
            </div>

            <!-- MAFI Score -->
            <div class="card">
                <h2>MAFI Score</h2>
                <div id="mafiScoreDisplay" class="mafi-score mafi-robust">
                    <span id="mafiValue">0.00</span>
                    <span class="classification-label" id="mafiClassification">Robust</span>
                </div>
                <div id="mafiCIDisplay" style="text-align: center; margin-top: -10px; margin-bottom: 15px; font-size: 0.95rem; color: var(--text-secondary);">
                    <span id="mafiCI">95% CI: [---, ---]</span>
                </div>

                <div id="interpretationBox" class="info-box">
                    <strong>Interpretation:</strong>
                    <span id="mafiInterpretation">--</span>
                </div>

                <h3>Component Breakdown</h3>
                <div class="component-bar" id="componentBar"></div>
                <div class="legend" id="componentLegend"></div>

                <h3>MAFI Variants</h3>
                <div class="variant-comparison">
                    <div class="variant-card">
                        <h4>5-Component</h4>
                        <div class="score" id="mafi5comp">--</div>
                        <span class="badge" id="mafi5compBadge">--</span>
                    </div>
                    <div class="variant-card">
                        <h4>3-Component</h4>
                        <div class="score" id="mafi3comp">--</div>
                        <span class="badge" id="mafi3compBadge">--</span>
                    </div>
                    <div class="variant-card">
                        <h4>Simple</h4>
                        <div class="score" id="mafiSimple">--</div>
                        <span class="badge" id="mafiSimpleBadge">--</span>
                    </div>
                    <div class="variant-card">
                        <h4>Empirical</h4>
                        <div class="score" id="mafiEmpirical">--</div>
                        <span class="badge" id="mafiEmpiricalBadge">--</span>
                    </div>
                </div>
            </div>

            <!-- Fragility Details -->
            <div class="card">
                <h2>Fragility Analysis</h2>
                <div class="grid-2">
                    <div>
                        <h3>Direction Fragility (DFI)</h3>
                        <div class="stat-box">
                            <div class="value" id="dfiValue">--</div>
                            <div class="label">Studies changing direction</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="dfiBar" style="width: 0%; background: var(--primary);">0%</div>
                        </div>
                    </div>
                    <div>
                        <h3>Significance Fragility (SFI)</h3>
                        <div class="stat-box">
                            <div class="value" id="sfiValue">--</div>
                            <div class="label">Studies changing significance</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="sfiBar" style="width: 0%; background: var(--info);">0%</div>
                        </div>
                    </div>
                </div>
                <div class="grid-2" style="margin-top: 20px;">
                    <div>
                        <h3>Clinical Fragility (CFI)</h3>
                        <div class="stat-box">
                            <div class="value" id="cfiValue">--</div>
                            <div class="label">Studies crossing clinical threshold</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cfiBar" style="width: 0%; background: var(--warning);">0%</div>
                        </div>
                    </div>
                    <div>
                        <h3>Effect & CI Stability</h3>
                        <div class="stat-box">
                            <div class="value" id="effectStability">--</div>
                            <div class="label">Max effect change | CI fragility quotient</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forest Plot -->
            <div class="card">
                <h2>Leave-One-Out Analysis</h2>
                <div id="forestPlot" class="forest-plot"></div>
            </div>

            <!-- GRADE Assessment -->
            <div class="card">
                <h2>GRADE Assessment</h2>
                <div id="gradeAssessment"></div>
            </div>

            <!-- Recommendations -->
            <div class="card">
                <h2>Recommendations</h2>
                <div id="recommendations"></div>
            </div>

            <!-- Export -->
            <div class="card">
                <h2>Export</h2>
                <div class="btn-group">
                    <button class="btn-primary" onclick="exportCSV()">Export CSV</button>
                    <button class="btn-secondary" onclick="exportJSON()">Export JSON</button>
                    <button class="btn-secondary" onclick="copyReport()">Copy Report</button>
                </div>
                <div class="export-section">
                    <textarea id="exportText" readonly></textarea>
                </div>
            </div>
        </div>

        <footer style="text-align: center; padding: 30px; color: var(--text-muted);">
            <p>MAFI Calculator Complete Edition v1.0</p>
            <p>Validated on 4,424 Cochrane meta-analyses | For research and educational purposes</p>
        </footer>
    </div>

    <script>
        // ============================================================
        // MAFI Calculator - Complete Implementation
        // ============================================================

        let studies = [];
        let analysisResults = null;

        document.addEventListener('DOMContentLoaded', () => {
            addStudyRow(); addStudyRow(); addStudyRow();
        });

        // ============================================================
        // Navigation
        // ============================================================

        function switchMainTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            // Find and activate the correct tab by matching onclick content
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.getAttribute('onclick') && t.getAttribute('onclick').includes(tab)) {
                    t.classList.add('active');
                }
            });
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // ============================================================
        // Study Management
        // ============================================================

        function addStudyRow(name = '', effect = '', se = '') {
            const tbody = document.getElementById('studyTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" placeholder="Study name" value="${name}"></td>
                <td><input type="number" step="0.001" placeholder="Effect" value="${effect}"></td>
                <td><input type="number" step="0.001" placeholder="SE" value="${se}"></td>
                <td><button class="remove-btn" onclick="this.closest('tr').remove()">Remove</button></td>
            `;
            tbody.appendChild(row);
        }

        function addMultipleRows() { for (let i = 0; i < 5; i++) addStudyRow(); }

        function clearAllStudies() {
            document.getElementById('studyTableBody').innerHTML = '';
            addStudyRow(); addStudyRow();
        }

        function getStudiesFromTable() {
            const rows = document.querySelectorAll('#studyTableBody tr');
            return Array.from(rows).map(row => {
                const inputs = row.querySelectorAll('input');
                return {
                    name: inputs[0].value.trim(),
                    effect: parseFloat(inputs[1].value),
                    se: parseFloat(inputs[2].value)
                };
            }).filter(s => s.name && !isNaN(s.effect) && !isNaN(s.se) && s.se > 0);
        }

        // ============================================================
        // Case Studies Data
        // ============================================================

        const caseStudiesData = {
            antidepressants: {
                name: "Antidepressants for Major Depression",
                measure: "SMD",
                threshold: 0.5,
                studies: [
                    ["Cipriani 2018a", -0.45, 0.15],
                    ["Fournier 2010", -0.62, 0.18],
                    ["Gibbons 2012", -0.38, 0.12],
                    ["Hieronymus 2016", -0.51, 0.14],
                    ["Khan 2002", -0.29, 0.16],
                    ["Kirsch 2008", -0.32, 0.13],
                    ["Turner 2008", -0.42, 0.17],
                    ["Undurraga 2012", -0.48, 0.11]
                ]
            },
            mortality: {
                name: "Statin Therapy and Mortality",
                measure: "OR",
                threshold: 0.8,
                studies: [
                    ["4S 1994", 0.70, 0.12],
                    ["WOSCOPS 1995", 0.78, 0.15],
                    ["CARE 1996", 0.76, 0.14],
                    ["LIPID 1998", 0.78, 0.11],
                    ["AFCAPS 1998", 0.85, 0.18],
                    ["HPS 2002", 0.87, 0.08],
                    ["PROSPER 2002", 0.97, 0.12],
                    ["ALLHAT 2002", 0.99, 0.14],
                    ["ASCOT 2003", 0.87, 0.16],
                    ["CARDS 2004", 0.73, 0.22],
                    ["TNT 2005", 0.78, 0.13],
                    ["JUPITER 2008", 0.80, 0.15]
                ]
            },
            pain: {
                name: "Acupuncture for Low Back Pain",
                measure: "MD",
                threshold: 15,
                studies: [
                    ["Cherkin 2009", -12.5, 4.2],
                    ["Haake 2007", -8.7, 5.1],
                    ["Brinkhaus 2006", -15.2, 3.8],
                    ["Thomas 2006", -11.3, 4.5],
                    ["Molsberger 2002", -9.8, 5.9],
                    ["Leibing 2002", -6.1, 6.5]
                ]
            },
            vaccine: {
                name: "COVID-19 Vaccine Efficacy",
                measure: "RR",
                threshold: 0.5,
                studies: [
                    ["Pfizer Phase 3", 0.05, 0.25],
                    ["Moderna Phase 3", 0.06, 0.28],
                    ["AstraZeneca Pool", 0.30, 0.15],
                    ["J&J Phase 3", 0.34, 0.18],
                    ["Novavax Phase 3", 0.10, 0.30]
                ]
            },
            fragile: {
                name: "Exercise for Fibromyalgia (Fragile)",
                measure: "SMD",
                threshold: 0.5,
                studies: [
                    ["Busch 2007", -0.35, 0.28],
                    ["Hauser 2010", -0.52, 0.32],
                    ["Kelley 2010", -0.18, 0.25],
                    ["Bidonde 2014", -0.41, 0.35]
                ]
            },
            depression: {
                name: "Example: Depression Treatment",
                measure: "SMD",
                threshold: 0.5,
                studies: [
                    ["Smith 2018", -0.45, 0.15],
                    ["Johnson 2019", -0.62, 0.18],
                    ["Williams 2019", -0.38, 0.12],
                    ["Brown 2020", -0.51, 0.14],
                    ["Davis 2020", -0.29, 0.16],
                    ["Miller 2021", -0.55, 0.13],
                    ["Wilson 2021", -0.42, 0.17],
                    ["Taylor 2022", -0.48, 0.11]
                ]
            }
        };

        function loadCaseStudy(key) {
            const cs = caseStudiesData[key];
            document.getElementById('effectMeasure').value = cs.measure;
            document.getElementById('clinicalThreshold').value = cs.threshold;
            clearAllStudies();
            document.getElementById('studyTableBody').innerHTML = '';
            cs.studies.forEach(s => addStudyRow(s[0], s[1], s[2]));
            switchMainTab('calculator');
            document.querySelector('.tab').click();
        }

        function loadExampleData(key) {
            loadCaseStudy(key);
        }

        // ============================================================
        // Statistical Functions
        // ============================================================

        function normalCDF(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
            const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            return 0.5 * (1.0 + sign * y);
        }

        function pValueFromZ(z) { return 2 * (1 - normalCDF(Math.abs(z))); }

        function chiSquareCDF(x, df) {
            // Chi-square CDF using regularized incomplete gamma function
            if (x <= 0) return 0;
            if (x > 1000) return 1;  // Numerical stability
            return gammainc(df / 2, x / 2);
        }

        // Regularized lower incomplete gamma function P(a, x)
        function gammainc(a, x) {
            if (x < 0 || a <= 0) return 0;
            if (x === 0) return 0;
            if (x > 200) return 1;  // Effectively complete for large x

            // Use series expansion for small x, continued fraction for large x
            if (x < a + 1) {
                // Series expansion: P(a,x) = e^(-x) * x^a * sum(x^n / Gamma(a+n+1))
                let sum = 1 / a;
                let term = 1 / a;
                for (let n = 1; n < 200; n++) {
                    term *= x / (a + n);
                    sum += term;
                    if (Math.abs(term) < sum * 1e-14) break;
                }
                return Math.exp(-x + a * Math.log(x) - Math.log(gamma(a))) * sum;
            } else {
                // Continued fraction for upper incomplete gamma, then 1 - Q(a,x)
                // Q(a,x) = e^(-x) * x^a / Gamma(a) * CF
                const eps = 1e-14;
                let b = x + 1 - a;
                let c = 1 / 1e-30;
                let d = 1 / b;
                let h = d;
                for (let i = 1; i < 200; i++) {
                    const an = -i * (i - a);
                    b += 2;
                    d = an * d + b;
                    if (Math.abs(d) < 1e-30) d = 1e-30;
                    c = b + an / c;
                    if (Math.abs(c) < 1e-30) c = 1e-30;
                    d = 1 / d;
                    const del = d * c;
                    h *= del;
                    if (Math.abs(del - 1) < eps) break;
                }
                const Q = Math.exp(-x + a * Math.log(x) - Math.log(gamma(a))) * h;
                return 1 - Q;
            }
        }

        function gamma(n) {
            if (n === 1) return 1;
            if (n === 0.5) return Math.sqrt(Math.PI);
            if (n < 1) return gamma(n + 1) / n;
            const g = 7;
            const c = [0.99999999999980993, 676.5203681218851, -1259.1392167224028,
                       771.32342877765313, -176.61502916214059, 12.507343278686905,
                       -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
            n -= 1;
            let x = c[0];
            for (let i = 1; i < g + 2; i++) x += c[i] / (n + i);
            const t = n + g + 0.5;
            return Math.sqrt(2 * Math.PI) * Math.pow(t, n + 0.5) * Math.exp(-t) * x;
        }

        // ============================================================
        // Meta-Analysis
        // ============================================================

        function runRandomEffectsMA(studies) {
            const k = studies.length;
            if (k < 2) return null;

            studies.forEach(s => { s.variance = s.se * s.se; s.weight = 1 / s.variance; });

            const sumW = studies.reduce((a, s) => a + s.weight, 0);
            const sumWY = studies.reduce((a, s) => a + s.weight * s.effect, 0);
            const fixedEffect = sumWY / sumW;

            const Q = studies.reduce((a, s) => a + s.weight * Math.pow(s.effect - fixedEffect, 2), 0);
            const df = k - 1;
            const pQ = 1 - chiSquareCDF(Q, df);

            const C = sumW - studies.reduce((a, s) => a + s.weight * s.weight, 0) / sumW;
            let tau2 = Math.max(0, (Q - df) / C);
            const I2 = Math.max(0, (Q - df) / Q * 100);

            studies.forEach(s => { s.reWeight = 1 / (s.variance + tau2); });

            const sumREW = studies.reduce((a, s) => a + s.reWeight, 0);
            const sumREWY = studies.reduce((a, s) => a + s.reWeight * s.effect, 0);
            const pooledEffect = sumREWY / sumREW;
            const pooledSE = Math.sqrt(1 / sumREW);
            const pooledZ = pooledEffect / pooledSE;
            const pValue = pValueFromZ(pooledZ);

            return {
                k, pooledEffect, pooledSE,
                ci95Lower: pooledEffect - 1.96 * pooledSE,
                ci95Upper: pooledEffect + 1.96 * pooledSE,
                zValue: pooledZ, pValue, Q, pQ, I2, tau2,
                significant: pValue < 0.05,
                direction: pooledEffect >= 0 ? 'positive' : 'negative'
            };
        }

        // ============================================================
        // Leave-One-Out & Fragility
        // ============================================================

        function leaveOneOutAnalysis(studies, fullResult, clinicalThreshold) {
            const effectMeasure = document.getElementById('effectMeasure').value;
            const isRatio = ['OR', 'RR', 'HR'].includes(effectMeasure);
            const nullValue = isRatio ? 1 : 0;

            let workingStudies = studies.map(s => ({
                ...s, effect: isRatio ? Math.log(s.effect) : s.effect
            }));

            const looResults = [];
            let directionChanges = 0, significanceChanges = 0, clinicalChanges = 0;
            let maxEffectChange = 0, maxCIChange = 0;

            const originalEffect = isRatio ? Math.log(fullResult.pooledEffect) : fullResult.pooledEffect;
            const originalSig = fullResult.significant;
            let originalClinical = null;

            if (clinicalThreshold) {
                if (isRatio) {
                    originalClinical = fullResult.pooledEffect < (1 / clinicalThreshold) || fullResult.pooledEffect > clinicalThreshold;
                } else {
                    originalClinical = Math.abs(fullResult.pooledEffect) >= clinicalThreshold;
                }
            }

            studies.forEach((study, i) => {
                const subset = workingStudies.filter((_, j) => j !== i);
                const looResult = runRandomEffectsMA(subset);
                if (!looResult) return;

                const looEffect = looResult.pooledEffect;
                const backTransformed = isRatio ? Math.exp(looEffect) : looEffect;

                const directionChanged = (originalEffect >= 0) !== (looEffect >= 0);
                if (directionChanged) directionChanges++;

                const sigChanged = originalSig !== looResult.significant;
                if (sigChanged) significanceChanges++;

                let clinicalChanged = false;
                if (clinicalThreshold) {
                    let looClinical = isRatio ?
                        (backTransformed < (1 / clinicalThreshold) || backTransformed > clinicalThreshold) :
                        Math.abs(backTransformed) >= clinicalThreshold;
                    clinicalChanged = originalClinical !== looClinical;
                    if (clinicalChanged) clinicalChanges++;
                }

                const effectChange = Math.abs(looEffect - originalEffect);
                maxEffectChange = Math.max(maxEffectChange, effectChange);

                const originalCIWidth = fullResult.ci95Upper - fullResult.ci95Lower;
                const looCIWidth = looResult.ci95Upper - looResult.ci95Lower;
                const ciChange = Math.abs(looCIWidth - originalCIWidth) / originalCIWidth;
                maxCIChange = Math.max(maxCIChange, ciChange);

                looResults.push({
                    studyName: study.name, originalEffect: study.effect,
                    pooledWithout: backTransformed,
                    ciLower: isRatio ? Math.exp(looResult.ci95Lower) : looResult.ci95Lower,
                    ciUpper: isRatio ? Math.exp(looResult.ci95Upper) : looResult.ci95Upper,
                    pValue: looResult.pValue, I2: looResult.I2,
                    directionChanged, significanceChanged: sigChanged, clinicalChanged, effectChange
                });
            });

            return {
                looResults, directionFragilityIndex: directionChanges,
                significanceFragilityIndex: significanceChanges,
                clinicalFragilityIndex: clinicalChanges,
                maxEffectChange, maxCIChange, fragilityQuotient: maxCIChange
            };
        }

        // ============================================================
        // MAFI Calculation
        // ============================================================

        function calculateMAFI(fragility, maResult, weights) {
            const k = maResult.k;
            const dfiRate = fragility.directionFragilityIndex / k;
            const sfiRate = fragility.significanceFragilityIndex / k;
            const cfiRate = fragility.clinicalFragilityIndex / k;
            const effectRate = Math.min(1, fragility.maxEffectChange);
            const ciRate = Math.min(1, fragility.fragilityQuotient);

            const totalWeight = weights.direction + weights.significance + weights.clinical + weights.effect + weights.ci;
            const w = {
                direction: weights.direction / totalWeight,
                significance: weights.significance / totalWeight,
                clinical: weights.clinical / totalWeight,
                effect: weights.effect / totalWeight,
                ci: weights.ci / totalWeight
            };

            const coreMAFI = w.direction * dfiRate + w.significance * sfiRate +
                            w.clinical * cfiRate + w.effect * effectRate + w.ci * ciRate;

            const hetPenalty = (maResult.I2 / 100) * 0.20;
            const kPenalty = Math.max(0, (1 - k / 20) * 0.30);

            return {
                score: Math.min(1, coreMAFI + hetPenalty + kPenalty),
                components: { direction: dfiRate, significance: sfiRate, clinical: cfiRate, effect: effectRate, ci: ciRate },
                penalties: { heterogeneity: hetPenalty, sampleSize: kPenalty },
                core: coreMAFI, weights: w
            };
        }

        function classifyMAFI(score) {
            if (score <= 0.15) return { label: 'Robust', class: 'robust', badge: 'badge-robust' };
            if (score <= 0.30) return { label: 'Low Fragility', class: 'low', badge: 'badge-low' };
            if (score <= 0.50) return { label: 'Moderate Fragility', class: 'moderate', badge: 'badge-moderate' };
            return { label: 'High Fragility', class: 'high', badge: 'badge-high' };
        }

        // Calculate 95% CI for MAFI using bootstrap resampling
        function calculateMAFIBootstrapCI(studies, fragility, maResult, weights, nBoot = 1000) {
            const k = studies.length;
            if (k < 4) return { lower: 0, upper: 1 };  // Not enough for stable CI

            const mafiScores = [];

            for (let b = 0; b < nBoot; b++) {
                // Resample LOO results with replacement
                const bootDFI = [];
                const bootSFI = [];
                const bootCFI = [];
                const bootEffect = [];
                const bootCI = [];

                for (let i = 0; i < k; i++) {
                    const idx = Math.floor(Math.random() * k);
                    const loo = fragility.looResults[idx];
                    bootDFI.push(loo.directionChanged ? 1 : 0);
                    bootSFI.push(loo.significanceChanged ? 1 : 0);
                    bootCFI.push(loo.clinicalRelevanceChanged ? 1 : 0);
                    bootEffect.push(Math.abs((loo.pooledWithout - maResult.pooledEffect) / maResult.pooledEffect));
                    bootCI.push(Math.abs(loo.pooledWithout) / Math.abs(maResult.ci95Upper - maResult.ci95Lower));
                }

                const dfiRate = bootDFI.reduce((a, b) => a + b, 0) / k;
                const sfiRate = bootSFI.reduce((a, b) => a + b, 0) / k;
                const cfiRate = bootCFI.reduce((a, b) => a + b, 0) / k;
                const effectRate = Math.min(1, bootEffect.reduce((a, b) => a + b, 0) / k);
                const ciRate = Math.min(1, bootCI.reduce((a, b) => a + b, 0) / k);

                const totalWeight = weights.direction + weights.significance + weights.clinical + weights.effect + weights.ci;
                const w = {
                    direction: weights.direction / totalWeight,
                    significance: weights.significance / totalWeight,
                    clinical: weights.clinical / totalWeight,
                    effect: weights.effect / totalWeight,
                    ci: weights.ci / totalWeight
                };

                let score = w.direction * dfiRate + w.significance * sfiRate + w.clinical * cfiRate +
                           w.effect * effectRate + w.ci * ciRate;

                // Penalties
                if (maResult.I2 > 50) score += 0.05;
                if (maResult.I2 > 75) score += 0.05;
                if (k < 5) score += 0.03;

                mafiScores.push(Math.max(0, Math.min(1, score)));
            }

            mafiScores.sort((a, b) => a - b);
            const lower = mafiScores[Math.floor(nBoot * 0.025)];
            const upper = mafiScores[Math.floor(nBoot * 0.975)];

            return { lower, upper };
        }

        // ============================================================
        // Main Analysis
        // ============================================================

        function runAnalysis() {
            studies = getStudiesFromTable();
            if (studies.length < 3) { alert('Please enter at least 3 studies.'); return; }

            const effectMeasure = document.getElementById('effectMeasure').value;
            const clinicalThreshold = parseFloat(document.getElementById('clinicalThreshold').value) || null;
            const isRatio = ['OR', 'RR', 'HR'].includes(effectMeasure);

            let analysisStudies = studies.map(s => ({ ...s, effect: isRatio ? Math.log(s.effect) : s.effect }));
            const maResult = runRandomEffectsMA(analysisStudies);
            if (!maResult) { alert('Error in meta-analysis.'); return; }

            const displayResult = {
                ...maResult,
                pooledEffect: isRatio ? Math.exp(maResult.pooledEffect) : maResult.pooledEffect,
                ci95Lower: isRatio ? Math.exp(maResult.ci95Lower) : maResult.ci95Lower,
                ci95Upper: isRatio ? Math.exp(maResult.ci95Upper) : maResult.ci95Upper
            };

            const fragility = leaveOneOutAnalysis(studies, displayResult, clinicalThreshold);

            const weights5comp = { direction: 0.30, significance: 0.25, clinical: 0.20, effect: 0.15, ci: 0.10 };
            const mafi5comp = calculateMAFI(fragility, maResult, weights5comp);
            const mafi3comp = calculateMAFI(fragility, maResult, { direction: 0.35, significance: 0.35, clinical: 0.00, effect: 0.00, ci: 0.30 });
            const mafiSimple = calculateMAFI(fragility, maResult, { direction: 0.50, significance: 0.50, clinical: 0.00, effect: 0.00, ci: 0.00 });
            const mafiEmpirical = calculateMAFI(fragility, maResult, { direction: 0.17, significance: 0.30, clinical: 0.00, effect: 0.00, ci: 0.52 });

            // Calculate 95% CI for primary MAFI score
            const mafiCI = calculateMAFIBootstrapCI(studies, fragility, maResult, weights5comp, 500);

            analysisResults = {
                studies, metaAnalysis: displayResult, fragility,
                mafi: { primary: mafi5comp, threeComp: mafi3comp, simple: mafiSimple, empirical: mafiEmpirical },
                mafiCI: mafiCI,
                settings: { effectMeasure, clinicalThreshold, isRatio }
            };

            displayResults();
        }

        // ============================================================
        // Display Results
        // ============================================================

        function displayResults() {
            const r = analysisResults;
            const ma = r.metaAnalysis;
            const frag = r.fragility;
            const mafi = r.mafi.primary;
            const isRatio = r.settings.isRatio;

            document.getElementById('resultsSection').classList.remove('hidden');

            // MA results
            document.getElementById('pooledEffect').textContent = ma.pooledEffect.toFixed(3);
            document.getElementById('pooledCI').textContent = `[${ma.ci95Lower.toFixed(3)}, ${ma.ci95Upper.toFixed(3)}]`;
            document.getElementById('pValue').textContent = ma.pValue < 0.001 ? '< 0.001' : ma.pValue.toFixed(4);
            document.getElementById('numStudies').textContent = ma.k;
            document.getElementById('i2Value').textContent = ma.I2.toFixed(1) + '%';
            document.getElementById('tau2Value').textContent = ma.tau2.toFixed(4);
            document.getElementById('qValue').textContent = `${ma.Q.toFixed(2)} (p=${ma.pQ < 0.001 ? '<0.001' : ma.pQ.toFixed(3)})`;

            // MAFI
            const classification = classifyMAFI(mafi.score);
            document.getElementById('mafiValue').textContent = mafi.score.toFixed(3);
            document.getElementById('mafiClassification').textContent = classification.label;
            document.getElementById('mafiScoreDisplay').className = 'mafi-score mafi-' + classification.class;

            // MAFI 95% CI
            if (r.mafiCI) {
                document.getElementById('mafiCI').textContent =
                    `95% CI: [${r.mafiCI.lower.toFixed(3)}, ${r.mafiCI.upper.toFixed(3)}]`;
            }

            const interpretations = {
                robust: 'This meta-analysis shows highly robust conclusions. Removing any single study is unlikely to change the overall findings.',
                low: 'This meta-analysis shows minor sensitivity to individual studies. Results are generally stable.',
                moderate: 'This meta-analysis shows moderate fragility. Conclusions should be interpreted with caution.',
                high: 'This meta-analysis shows high fragility. Conclusions are unstable and heavily dependent on individual studies.'
            };
            document.getElementById('mafiInterpretation').textContent = interpretations[classification.class];
            document.getElementById('interpretationBox').className = classification.class === 'robust' ? 'success-box' :
                classification.class === 'low' ? 'info-box' : classification.class === 'moderate' ? 'warning-box' : 'danger-box';

            displayComponentBar(mafi);

            // Variants
            displayVariant('mafi5comp', r.mafi.primary.score);
            displayVariant('mafi3comp', r.mafi.threeComp.score);
            displayVariant('mafiSimple', r.mafi.simple.score);
            displayVariant('mafiEmpirical', r.mafi.empirical.score);

            // Fragility indices
            document.getElementById('dfiValue').textContent = `${frag.directionFragilityIndex} / ${ma.k}`;
            document.getElementById('sfiValue').textContent = `${frag.significanceFragilityIndex} / ${ma.k}`;
            document.getElementById('cfiValue').textContent = r.settings.clinicalThreshold ? `${frag.clinicalFragilityIndex} / ${ma.k}` : 'N/A';
            document.getElementById('effectStability').textContent = `${frag.maxEffectChange.toFixed(3)} | ${frag.fragilityQuotient.toFixed(3)}`;

            updateProgressBar('dfiBar', frag.directionFragilityIndex / ma.k * 100);
            updateProgressBar('sfiBar', frag.significanceFragilityIndex / ma.k * 100);
            updateProgressBar('cfiBar', r.settings.clinicalThreshold ? frag.clinicalFragilityIndex / ma.k * 100 : 0);

            displayForestPlot(frag.looResults, ma, isRatio);
            displayGRADEAssessment(mafi.score, ma, frag);
            displayRecommendations(mafi.score, ma, frag);
            generateReportText();

            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayComponentBar(mafi) {
            const colors = {
                direction: '#3b82f6', significance: '#06b6d4', clinical: '#f59e0b',
                effect: '#8b5cf6', ci: '#ec4899', hetPenalty: '#ef4444', kPenalty: '#64748b'
            };

            const components = [
                { name: 'Direction', value: mafi.components.direction * mafi.weights.direction, color: colors.direction },
                { name: 'Significance', value: mafi.components.significance * mafi.weights.significance, color: colors.significance },
                { name: 'Clinical', value: mafi.components.clinical * mafi.weights.clinical, color: colors.clinical },
                { name: 'Effect', value: mafi.components.effect * mafi.weights.effect, color: colors.effect },
                { name: 'CI', value: mafi.components.ci * mafi.weights.ci, color: colors.ci },
                { name: 'Het. Penalty', value: mafi.penalties.heterogeneity, color: colors.hetPenalty },
                { name: 'k Penalty', value: mafi.penalties.sampleSize, color: colors.kPenalty }
            ];

            const total = components.reduce((a, c) => a + c.value, 0);
            let barHTML = '', legendHTML = '';

            components.forEach(c => {
                const pct = (c.value / Math.max(total, 0.01)) * 100;
                if (pct > 1) barHTML += `<div class="component-segment" style="width: ${pct}%; background: ${c.color};">${pct > 8 ? c.name.substring(0, 3) : ''}</div>`;
                legendHTML += `<div class="legend-item"><div class="legend-color" style="background: ${c.color};"></div><span>${c.name}: ${(c.value * 100).toFixed(1)}%</span></div>`;
            });

            document.getElementById('componentBar').innerHTML = barHTML;
            document.getElementById('componentLegend').innerHTML = legendHTML;
        }

        function displayVariant(id, score) {
            const classification = classifyMAFI(score);
            document.getElementById(id).textContent = score.toFixed(3);
            document.getElementById(id).style.color = `var(--${classification.class})`;
            const badge = document.getElementById(id + 'Badge');
            badge.textContent = classification.label;
            badge.className = 'badge ' + classification.badge;
        }

        function updateProgressBar(id, pct) {
            const bar = document.getElementById(id);
            bar.style.width = Math.min(100, pct) + '%';
            bar.textContent = pct.toFixed(1) + '%';
        }

        function displayForestPlot(looResults, ma, isRatio) {
            const container = document.getElementById('forestPlot');
            const nullValue = isRatio ? 1 : 0;

            let allValues = looResults.flatMap(r => [r.ciLower, r.ciUpper, r.pooledWithout]);
            allValues.push(ma.pooledEffect, ma.ci95Lower, ma.ci95Upper);

            const minVal = Math.min(...allValues), maxVal = Math.max(...allValues);
            const range = maxVal - minVal, padding = range * 0.1;
            const scaleMin = minVal - padding, scaleMax = maxVal + padding;
            const scale = (val) => ((val - scaleMin) / (scaleMax - scaleMin)) * 100;

            let html = `<div class="forest-row" style="font-weight: 600; background: var(--bg);">
                <div class="forest-label">Study Removed</div>
                <div class="forest-plot-area"><div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                    <span>${scaleMin.toFixed(2)}</span><span>Effect</span><span>${scaleMax.toFixed(2)}</span>
                </div></div>
                <div class="forest-effect">Effect [95% CI]</div>
                <div class="fragility-indicator">Fragile?</div>
            </div>`;

            html += `<div class="forest-row" style="background: #eff6ff;">
                <div class="forest-label"><strong>Overall</strong></div>
                <div class="forest-plot-area">
                    <div class="forest-line"></div>
                    <div class="forest-null" style="left: ${scale(nullValue)}%;"></div>
                    <div class="forest-ci" style="left: ${scale(ma.ci95Lower)}%; width: ${scale(ma.ci95Upper) - scale(ma.ci95Lower)}%; background: #1d4ed8;"></div>
                    <div class="forest-point" style="left: ${scale(ma.pooledEffect)}%; background: #1d4ed8; width: 16px; height: 16px;"></div>
                </div>
                <div class="forest-effect"><strong>${ma.pooledEffect.toFixed(3)}</strong> [${ma.ci95Lower.toFixed(2)}, ${ma.ci95Upper.toFixed(2)}]</div>
                <div class="fragility-indicator">-</div>
            </div>`;

            looResults.forEach(r => {
                const isFragile = r.directionChanged || r.significanceChanged || r.clinicalChanged;
                html += `<div class="forest-row" style="${isFragile ? 'background: #fef2f2;' : ''}">
                    <div class="forest-label" style="${isFragile ? 'color: var(--danger);' : ''}">${r.studyName}</div>
                    <div class="forest-plot-area">
                        <div class="forest-line"></div>
                        <div class="forest-null" style="left: ${scale(nullValue)}%;"></div>
                        <div class="forest-ci" style="left: ${scale(r.ciLower)}%; width: ${scale(r.ciUpper) - scale(r.ciLower)}%;"></div>
                        <div class="forest-point" style="left: ${scale(r.pooledWithout)}%;"></div>
                    </div>
                    <div class="forest-effect">${r.pooledWithout.toFixed(3)} [${r.ciLower.toFixed(2)}, ${r.ciUpper.toFixed(2)}]</div>
                    <div class="fragility-indicator">
                        ${r.directionChanged ? '<span class="badge badge-high">Dir</span>' : ''}
                        ${r.significanceChanged ? '<span class="badge badge-moderate">Sig</span>' : ''}
                        ${r.clinicalChanged ? '<span class="badge badge-low">Clin</span>' : ''}
                        ${!isFragile ? '<span style="color: var(--success);">-</span>' : ''}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // ============================================================
        // GRADE Assessment
        // ============================================================

        function displayGRADEAssessment(mafiScore, ma, frag) {
            const container = document.getElementById('gradeAssessment');
            const classification = classifyMAFI(mafiScore);

            let downgradeLevel = 0, downgradeReason = '';

            if (classification.class === 'high') {
                downgradeLevel = 2;
                downgradeReason = 'High fragility: conclusions highly unstable';
            } else if (classification.class === 'moderate') {
                downgradeLevel = 1;
                downgradeReason = 'Moderate fragility: conclusions may change with study exclusion';
            } else if (classification.class === 'low' && ma.pValue > 0.01 && ma.pValue < 0.05) {
                downgradeLevel = 1;
                downgradeReason = 'Borderline significance combined with low fragility';
            }

            // Additional considerations
            let additionalConcerns = [];
            if (ma.I2 > 75) additionalConcerns.push('Considerable heterogeneity (I² > 75%)');
            if (ma.k < 5) additionalConcerns.push('Very few studies (k < 5)');
            if (frag.significanceFragilityIndex > 0 && ma.significant) additionalConcerns.push(`${frag.significanceFragilityIndex} study(ies) can reverse significance`);

            let html = `
                <h3>MAFI-Informed GRADE Suggestion</h3>

                <div class="${downgradeLevel === 0 ? 'success-box' : downgradeLevel === 1 ? 'warning-box' : 'danger-box'}">
                    <h4>Suggested Downgrade for Imprecision/Fragility: ${downgradeLevel} level(s)</h4>
                    <p>${downgradeLevel === 0 ? 'No downgrade suggested based on fragility assessment.' : downgradeReason}</p>
                </div>

                <h4>Certainty Assessment</h4>
                <table>
                    <tr>
                        <th>Starting Point</th>
                        <td>High (RCT evidence)</td>
                    </tr>
                    <tr>
                        <th>MAFI-Based Downgrade</th>
                        <td>${downgradeLevel} level(s) ${downgradeLevel > 0 ? '(for imprecision/fragility)' : ''}</td>
                    </tr>
                    <tr>
                        <th>Suggested Certainty</th>
                        <td><strong>${['High', 'Moderate', 'Low', 'Very Low'][Math.min(downgradeLevel, 3)]}</strong>
                            (before considering other domains)</td>
                    </tr>
                </table>

                ${additionalConcerns.length > 0 ? `
                    <div class="warning-box">
                        <h4>Additional Considerations</h4>
                        <ul style="margin-left: 20px;">
                            ${additionalConcerns.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                <h4>GRADE Evidence Profile Entry (Suggested)</h4>
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px;">
                    <strong>Imprecision:</strong> ${downgradeLevel === 0 ? 'Not serious' : downgradeLevel === 1 ? 'Serious' : 'Very serious'}<br>
                    <strong>Explanation:</strong> MAFI score ${mafiScore.toFixed(3)} (${classification.label}).
                    ${frag.directionFragilityIndex > 0 ? `DFI: ${frag.directionFragilityIndex}/${ma.k} studies change direction. ` : ''}
                    ${frag.significanceFragilityIndex > 0 ? `SFI: ${frag.significanceFragilityIndex}/${ma.k} studies change significance.` : ''}
                </div>

                <div class="info-box" style="margin-top: 20px;">
                    <strong>Note:</strong> This is a SUGGESTION only. Final GRADE assessments should consider all five domains
                    (risk of bias, inconsistency, indirectness, imprecision, publication bias) and be made by the review team.
                    MAFI provides supplementary information for the imprecision assessment.
                </div>
            `;

            container.innerHTML = html;

            // Update GRADE tab
            document.getElementById('gradeResults').innerHTML = html;
            document.getElementById('gradeResults').classList.remove('hidden');
        }

        function displayRecommendations(mafiScore, ma, frag) {
            const container = document.getElementById('recommendations');
            const classification = classifyMAFI(mafiScore);

            let html = '<div class="grid-2">';

            html += `<div class="${classification.class === 'robust' ? 'success-box' : classification.class === 'low' ? 'info-box' : classification.class === 'moderate' ? 'warning-box' : 'danger-box'}">
                <h4>For Systematic Reviewers</h4>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    ${classification.class === 'robust' ? '<li>Report MAFI score to demonstrate robustness</li>' : ''}
                    ${classification.class !== 'robust' ? '<li>Include leave-one-out analysis in supplementary material</li>' : ''}
                    ${frag.directionFragilityIndex > 0 ? `<li>Flag ${frag.directionFragilityIndex} influential study(ies) that change direction</li>` : ''}
                    ${frag.significanceFragilityIndex > 0 ? `<li>Acknowledge ${frag.significanceFragilityIndex} study(ies) affecting significance</li>` : ''}
                    ${ma.k < 10 ? '<li>State that additional studies are needed</li>' : ''}
                </ul>
            </div>`;

            html += `<div class="info-box">
                <h4>For Guideline Developers</h4>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    ${classification.class === 'robust' ? '<li>Evidence supports strong recommendations</li>' : ''}
                    ${classification.class === 'low' ? '<li>Consider conditional recommendation</li>' : ''}
                    ${classification.class === 'moderate' ? '<li>Recommend conditional/weak recommendation</li>' : ''}
                    ${classification.class === 'high' ? '<li>Avoid strong recommendations based on this evidence</li>' : ''}
                    <li>Consider MAFI in certainty assessment</li>
                </ul>
            </div>`;

            html += '</div>';

            html += `<h3>Study-Specific Findings</h3>`;

            const influential = frag.looResults.filter(r => r.directionChanged || r.significanceChanged);
            if (influential.length > 0) {
                html += `<div class="warning-box"><h4>Influential Studies</h4><ul style="margin-left: 20px;">`;
                influential.forEach(s => {
                    const reasons = [];
                    if (s.directionChanged) reasons.push('reverses direction');
                    if (s.significanceChanged) reasons.push('changes significance');
                    html += `<li><strong>${s.studyName}:</strong> Removal ${reasons.join(' and ')}</li>`;
                });
                html += `</ul></div>`;
            } else {
                html += `<div class="success-box">No single study critically influences the conclusion.</div>`;
            }

            container.innerHTML = html;
        }

        // ============================================================
        // Export
        // ============================================================

        function generateReportText() {
            const r = analysisResults;
            const ma = r.metaAnalysis;
            const frag = r.fragility;
            const mafi = r.mafi.primary;
            const classification = classifyMAFI(mafi.score);

            let report = `MAFI ANALYSIS REPORT
${'='.repeat(60)}

META-ANALYSIS SUMMARY
Effect Measure: ${r.settings.effectMeasure}
Studies: ${ma.k}
Pooled Effect: ${ma.pooledEffect.toFixed(4)} [95% CI: ${ma.ci95Lower.toFixed(4)}, ${ma.ci95Upper.toFixed(4)}]
P-value: ${ma.pValue < 0.001 ? '< 0.001' : ma.pValue.toFixed(4)}
I²: ${ma.I2.toFixed(1)}% | τ²: ${ma.tau2.toFixed(4)}

MAFI RESULTS
Score: ${mafi.score.toFixed(3)} (${classification.label})

Components:
- Direction Fragility: ${frag.directionFragilityIndex}/${ma.k}
- Significance Fragility: ${frag.significanceFragilityIndex}/${ma.k}
- Clinical Fragility: ${r.settings.clinicalThreshold ? frag.clinicalFragilityIndex + '/' + ma.k : 'N/A'}
- Max Effect Change: ${frag.maxEffectChange.toFixed(4)}
- CI Fragility Quotient: ${frag.fragilityQuotient.toFixed(4)}

GRADE SUGGESTION
Suggested downgrade: ${classification.class === 'high' ? '2 levels' : classification.class === 'moderate' ? '1 level' : 'None'}

LEAVE-ONE-OUT RESULTS
`;
            frag.looResults.forEach(loo => {
                const flags = [];
                if (loo.directionChanged) flags.push('DIR');
                if (loo.significanceChanged) flags.push('SIG');
                report += `${loo.studyName}: ${loo.pooledWithout.toFixed(4)} ${flags.length ? '** ' + flags.join(',') : ''}\n`;
            });

            report += `\nGenerated by MAFI Calculator v1.0`;

            document.getElementById('exportText').value = report;
        }

        function exportCSV() {
            const frag = analysisResults.fragility;
            let csv = 'Study,Pooled_Without,CI_Lower,CI_Upper,Direction_Changed,Significance_Changed\n';
            frag.looResults.forEach(r => {
                csv += `"${r.studyName}",${r.pooledWithout},${r.ciLower},${r.ciUpper},${r.directionChanged},${r.significanceChanged}\n`;
            });
            downloadFile('mafi_results.csv', csv, 'text/csv');
        }

        function exportJSON() {
            downloadFile('mafi_results.json', JSON.stringify(analysisResults, null, 2), 'application/json');
        }

        function copyReport() {
            const text = document.getElementById('exportText');
            text.select();
            document.execCommand('copy');
            alert('Report copied!');
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================================
        // CSV IMPORT FUNCTION
        // ============================================================
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.trim().split('\n');

                // Clear existing studies
                document.getElementById('studyTableBody').innerHTML = '';

                // Skip header if present
                const startIdx = lines[0].toLowerCase().includes('study') ||
                                 lines[0].toLowerCase().includes('name') ? 1 : 0;

                for (let i = startIdx; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Parse CSV (handle both comma and tab delimited)
                    let cols;
                    if (line.includes('\t')) {
                        cols = line.split('\t');
                    } else {
                        // Handle quoted values in CSV
                        cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
                        cols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                    }

                    if (cols.length >= 3) {
                        addStudyRow();
                        const rows = document.querySelectorAll('#studyTableBody tr');
                        const lastRow = rows[rows.length - 1];
                        const inputs = lastRow.querySelectorAll('input');

                        inputs[0].value = cols[0] || 'Study ' + i;  // Study name
                        inputs[1].value = parseFloat(cols[1]) || 0;  // Effect size
                        inputs[2].value = parseFloat(cols[2]) || 0;  // SE
                        if (inputs[3] && cols[3]) inputs[3].value = parseInt(cols[3]) || '';  // N
                    }
                }

                alert('Imported ' + (lines.length - startIdx) + ' studies from CSV');
            };
            reader.readAsText(file);
            event.target.value = '';  // Reset file input
        }

        // ============================================================
        // SESSION SAVE/LOAD FUNCTIONS
        // ============================================================
        function saveSession() {
            const session = {
                timestamp: new Date().toISOString(),
                effectMeasure: document.getElementById('effectMeasure').value,
                clinicalThreshold: document.getElementById('clinicalThreshold').value,
                studies: getStudiesFromTable(),
                analysisResults: analysisResults
            };

            const filename = 'mafi_session_' + new Date().toISOString().slice(0,10) + '.json';
            downloadFile(filename, JSON.stringify(session, null, 2), 'application/json');
        }

        function loadSession() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const session = JSON.parse(e.target.result);

                        // Restore settings
                        if (session.effectMeasure) {
                            document.getElementById('effectMeasure').value = session.effectMeasure;
                        }
                        if (session.clinicalThreshold) {
                            document.getElementById('clinicalThreshold').value = session.clinicalThreshold;
                        }

                        // Restore studies
                        if (session.studies && session.studies.length > 0) {
                            document.getElementById('studyTableBody').innerHTML = '';
                            session.studies.forEach(study => {
                                addStudyRow();
                                const rows = document.querySelectorAll('#studyTableBody tr');
                                const lastRow = rows[rows.length - 1];
                                const inputs = lastRow.querySelectorAll('input');

                                inputs[0].value = study.name || '';
                                inputs[1].value = study.effect || '';
                                inputs[2].value = study.se || '';
                                if (inputs[3]) inputs[3].value = study.n || '';
                            });
                        }

                        // Restore analysis results if available
                        if (session.analysisResults) {
                            analysisResults = session.analysisResults;
                            displayResults();
                        }

                        alert('Session loaded successfully! (' + session.studies.length + ' studies)');
                    } catch (err) {
                        alert('Error loading session: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
    </script>
</body>
</html>
